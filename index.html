<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Ad Generator - fal.ai</title>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --text-color: #2c3e50;
            --bg-color: #f9f9f9;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.6;
        }

        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.2rem;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            transition: 
                background-color 0.3s ease,
                transform 0.1s ease;
            font-weight: 600;
        }

        button:active {
            transform: scale(0.98);
        }

        button:hover:not(:disabled) {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .status-indicators {
            margin: 2rem 0;
        }

        .step {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 1rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            position: relative;
        }

        .step.active {
            opacity: 1;
            border-left: 4px solid var(--primary-color);
        }

        .step.completed {
            background: #e8f4fc;
            opacity: 1;
        }

        .step.completed::after {
            content: '‚úì';
            margin-left: auto;
            color: var(--success-color);
            font-weight: bold;
        }

        .step.error {
            background: #f8d7da;
            border-color: var(--error-color);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .spinner {
            animation: rotate 1.5s linear infinite;
        }

        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        .spinner circle {
            animation: dash 1.5s ease-in-out infinite;
        }

        @keyframes dash {
            0% { stroke-dasharray: 1, 200; }
            50% { stroke-dasharray: 89, 200; }
            100% { stroke-dasharray: 89, 200; }
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            background: #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .error {
            background: #f8d7da;
            color: var(--error-color);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            display: none;
        }

        .security-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Video Ad Generator</h1>
        
        <form id="ad-form" aria-label="Video ad generation form">
            <div class="form-group">
                <label for="api-key">fal.ai API Key</label>
                <div class="security-actions">
                    <input type="password" id="api-key" required
                           autocomplete="off"
                           aria-describedby="api-key-help">
                    <button type="button" id="clear-key" class="secondary">Clear</button>
                </div>
                <small id="api-key-help" class="help-text">
                    Your API key is stored securely in session storage
                </small>
            </div>

            <div class="form-group">
                <label for="marketing-text">Marketing Content</label>
                <textarea id="marketing-text" required
                          placeholder="Describe your product or service..."></textarea>
            </div>

            <div class="form-group">
                <label for="brand">Brand Name</label>
                <input type="text" id="brand" required
                       placeholder="Your company/brand name">
            </div>

            <div class="form-group">
                <label for="style">Visual Style</label>
                <select id="style">
                    <option value="modern">Modern - Clean and professional</option>
                    <option value="vintage">Vintage - Classic retro feel</option>
                    <option value="energetic">Energetic - Dynamic and bold</option>
                </select>
            </div>

            <div class="form-group">
                <label for="voice">Voice Style</label>
                <select id="voice">
                    <option value="professional">Professional</option>
                    <option value="friendly">Friendly</option>
                    <option value="authoritative">Authoritative</option>
                </select>
            </div>

            <button type="submit" id="generate-btn">
                Generate Video Ad
            </button>
        </form>

        <div class="error" id="error-message" role="alert" aria-live="assertive"></div>

        <div class="status-indicators">
            <div class="step" id="step1">
                <span aria-hidden="true">‚è≥</span>
                Creating visual concept...
            </div>
            <div class="step" id="step2">
                <span aria-hidden="true">‚è≥</span>
                Generating video content...
            </div>
            <div class="step" id="step3">
                <span aria-hidden="true">‚è≥</span>
                Producing voiceover...
            </div>
            <div class="step" id="step4">
                <span aria-hidden="true">‚è≥</span>
                Finalizing composition...
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner">
                <svg width="40" height="40" viewBox="0 0 50 50" role="status">
                    <circle cx="25" cy="25" r="20" fill="none" 
                            stroke="currentColor" stroke-width="5"
                            stroke-linecap="round" />
                    <title>Loading indicator</title>
                </svg>
            </div>
            <div class="progress-text" aria-live="polite">Initializing process...</div>
        </div>

        <div id="result" class="result" aria-live="polite">
            <h2>Your Video Ad</h2>
            <div class="video-container">
                <video id="video-result" controls playsinline>
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </div>
    <script>
        (function() {
            'use strict';

            // ... (keep config and state objects the same) ...

            // DOM Elements
            const form = document.getElementById('ad-form');
            const videoResult = document.getElementById('video-result');
            const errorEl = document.getElementById('error-message');
            const steps = Array.from(document.querySelectorAll('.step'));
            const progressText = document.querySelector('.progress-text');

            // Initialize
            function init() {
                loadSettings();
                setupEventListeners();
            }

            // ... (keep loadSettings/saveSettings the same) ...

            function setupEventListeners() {
                form.addEventListener('submit', handleSubmit);
                form.addEventListener('input', debounce(saveSettings, 500));
                document.getElementById('clear-key').addEventListener('click', clearApiKey);
                videoResult.addEventListener('error', handleVideoError);
            }

            function clearApiKey() {
                document.getElementById('api-key').value = '';
                saveSettings();
            }

            function handleVideoError() {
                handleError(new Error('Failed to load video player'));
            }

            // ... (keep handleSubmit/getFormData/validateFormData the same) ...

            async function processGenerationSteps(formData) {
                try {
                    resetSteps();
                    updateProgress('Starting generation process...');

                    // Step 1: Generate video concept
                    activateStep(0);
                    const videoPrompt = createVideoPrompt(formData);
                    
                    // Step 2: Generate video
                    activateStep(1);
                    const video = await polledApiCall(
                        () => generateVideo(formData.apiKey, videoPrompt),
                        'Video generation'
                    );
                    
                    // Step 3: Generate audio
                    activateStep(2);
                    const audio = await polledApiCall(
                        () => generateAudio(formData),
                        'Audio generation'
                    );
                    
                    // Step 4: Combine assets
                    activateStep(3);
                    const finalVideo = await polledApiCall(
                        () => combineAssets(formData.apiKey, video, audio),
                        'Video composition'
                    );
                    
                    // Display result
                    displayResult(finalVideo);
                    steps.forEach(step => step.classList.add('completed'));
                    
                } catch (error) {
                    steps[state.currentStep].classList.add('error');
                    throw error;
                }
            }

            function resetSteps() {
                steps.forEach(step => {
                    step.classList.remove('active', 'completed', 'error');
                });
            }

            function activateStep(index) {
                state.currentStep = index;
                steps[index].classList.add('active');
            }

            function updateProgress(text) {
                progressText.textContent = text;
            }

            // ... (keep polledApiCall/pollForResult the same) ...

            async function generateVideo(apiKey, prompt) {
                try {
                    const endpoint = `${config.fal.baseUrl}/models/${config.fal.endpoints.video}/run`;
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Key ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt,
                            negative_prompt: "low quality, blurry, text",
                            num_frames: config.fal.defaults.duration * 24,
                            ...config.fal.defaults.resolution
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || 'Video generation failed');
                    }

                    return response.json();
                } catch (error) {
                    throw new Error(`Video API error: ${error.message}`);
                }
            }

            // ... (keep generateAudio the same) ...

            async function combineAssets(apiKey, video, audio) {
                try {
                    const endpoint = `${config.fal.baseUrl}/models/${config.fal.endpoints.compose}/run`;
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Key ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            video_url: video.url,
                            audio_url: audio.url,
                            output_format: "mp4"
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || 'Composition failed');
                    }

                    return response.json();
                } catch (error) {
                    throw new Error(`Composition API error: ${error.message}`);
                }
            }

            function displayResult(result) {
                videoResult.src = result.url;
                videoResult.load();
                document.getElementById('result').scrollIntoView({
                    behavior: 'smooth'
                });
            }

            function handleError(error) {
                console.error('Error:', error);
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            }

            function resetUIState() {
                errorEl.style.display = 'none';
                document.getElementById('result').style.display = 'none';
            }

            function updateProcessingState(isProcessing) {
                document.getElementById('generate-btn').disabled = isProcessing;
                document.getElementById('loading').style.display = 
                    isProcessing ? 'flex' : 'none';
                document.getElementById('result').style.display = 
                    isProcessing ? 'none' : 'block';
            }

            function debounce(fn, delay) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => fn(...args), delay);
                };
            }

            init();
        })();
    </script>
</body>
</html>
